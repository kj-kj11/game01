<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>電気イスゲーム</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background:
        radial-gradient(circle at top,#f97316 0,#7c2d12 45%,#020617 80%);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .app {
      width: 100%;
      max-width: 520px;
      padding: 16px;
      position: relative;
      z-index: 1;
    }

    .card {
      background: radial-gradient(circle at top,#111827,#020617 65%);
      border-radius: 20px;
      border: 2px solid #facc15;
      padding: 16px 16px 20px;
      box-shadow:
        0 0 0 4px rgba(15,23,42,0.85),
        0 26px 50px rgba(0,0,0,0.85);
      backdrop-filter: blur(10px);
    }

    h1 {
      margin: 0 0 8px;
      font-size: 22px;
      text-align: center;
      letter-spacing: 0.12em;
      color: #fef9c3;
      text-shadow:
        0 0 0 #000,
        2px 2px 0 #000,
        -2px 2px 0 #000,
        2px -2px 0 #000,
        -2px -2px 0 #000;
    }

    .subtitle {
      font-size: 11px;
      color: #e5e7eb;
      text-align: center;
      margin-bottom: 14px;
    }

    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    input[type="text"] {
      flex: 1;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #38bdf8;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.1s, filter 0.1s;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
      filter: brightness(0.95);
    }
    button:disabled {
      opacity: .45;
      cursor: default;
      box-shadow: none;
    }
    .btn-primary {
      background: radial-gradient(circle at top left,#facc15,#f97316 40%,#ef4444);
      color: #111827;
      font-weight: 700;
      box-shadow: 0 8px 22px rgba(248,181,48,0.7);
      width: 100%;
    }
    .btn-secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #4b5563;
      width: 100%;
    }

    .section-title {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .scoreboard {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      background: linear-gradient(90deg,#020617,#020617 30%,#0b1120);
      border: 1px solid #fbbf24;
      box-shadow: 0 0 12px rgba(250,191,36,0.3);
    }

    .round {
      font-size: 13px;
      color: #facc15;
      font-weight: 600;
    }

    .scores {
      display: flex;
      gap: 10px;
      font-size: 11px;
    }
    .scores span strong {
      font-size: 15px;
    }

    .label {
      font-size: 11px;
      color: #9ca3af;
    }

    .current-role {
      margin-bottom: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px dashed #f97316;
      font-size: 12px;
      background: rgba(15,23,42,0.9);
    }
    .current-role strong {
      color: #fef9c3;
    }

    /* 円形イス配置 */
    .chair-area {
      display: flex;
      justify-content: center;
      margin: 8px 0 12px;
    }
    .chair-circle {
      position: relative;
      width: 260px;
      height: 260px;
      border-radius: 50%;
      background: radial-gradient(circle at center,#020617 0,#020617 40%,#0b1120 70%);
      box-shadow: inset 0 0 30px rgba(0,0,0,0.6);
    }

    .chair {
      position: absolute;
      width: 56px;
      height: 56px;
      border-radius: 16px;
      border: 2px solid #4b5563;
      background: #020617;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 3px;
      transition: background 0.12s, transform 0.08s, border-color 0.12s, box-shadow 0.12s, opacity 0.12s;
    }

    /* 椅子ピクトグラム（背もたれ＋座面＋足） */
    .chair-icon {
      position: relative;
      width: 24px;
      height: 28px;
    }
    .chair-icon::before {
      /* 座面 */
      content: "";
      position: absolute;
      bottom: 6px;
      left: 2px;
      width: 20px;
      height: 6px;
      background: #e5e7eb;
      border-radius: 4px;
    }
    .chair-icon::after {
      /* 背もたれ */
      content: "";
      position: absolute;
      bottom: 14px;
      left: 5px;
      width: 6px;
      height: 12px;
      background: #e5e7eb;
      border-radius: 3px 3px 0 0;
    }
    .chair-leg {
      position: absolute;
      bottom: 0;
      width: 4px;
      height: 7px;
      background: #e5e7eb;
      border-radius: 2px;
    }
    .chair-leg.left {
      left: 5px;
    }
    .chair-leg.right {
      right: 5px;
    }

    .chair-label {
      font-size: 13px;
      font-weight: 700;
      color: #facc15;
    }

    .chair.selected-attack {
      background: radial-gradient(circle at top,#fb923c,#f97316 40%,#7c2d12);
      border-color: #fed7aa;
      box-shadow: 0 0 0 2px rgba(248,181,48,0.7);
      transform: scale(1.05);
    }
    .chair.selected-defend {
      background: radial-gradient(circle at top,#22c55e,#16a34a 40%,#14532d);
      border-color: #bbf7d0;
      box-shadow: 0 0 0 2px rgba(34,197,94,0.6);
      transform: scale(1.05);
    }
    .chair.reveal-hit {
      background: radial-gradient(circle at top,#ef4444,#b91c1c 40%,#450a0a);
      border-color: #fecaca;
      animation: pulseHit .7s ease-in-out 3;
    }
    .chair.reveal-safe {
      background: radial-gradient(circle at top,#22c55e,#16a34a 40%,#14532d);
      border-color: #bbf7d0;
      animation: pulseSafe .7s ease-in-out 3;
    }
    .chair-used {
      background: #020617;
      border-style: dashed;
      border-color: #374151;
      opacity: 0.35;
      cursor: default;
    }

    @keyframes pulseHit {
      0% { transform: scale(1); }
      50% { transform: scale(1.08); }
      100% { transform: scale(1); }
    }
    @keyframes pulseSafe {
      0% { transform: scale(1); }
      50% { transform: scale(1.08); }
      100% { transform: scale(1); }
    }

    .info {
      font-size: 12px;
      color: #f9fafb;
      min-height: 32px;
      margin-bottom: 6px;
    }
    .info strong {
      color: #fef9c3;
    }
    .highlight {
      color: #facc15;
      font-weight: 600;
    }

    .result {
      font-size: 13px;
      margin-bottom: 8px;
      min-height: 34px;
    }

    .small-note {
      font-size: 11px;
      color: #f9fafb;
      margin-top: 6px;
      line-height: 1.4;
    }

    /* タイトル画面 */
    .title-screen {
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at top,#fecaca 0,#f97316 35%,#7c2d12 70%),
        radial-gradient(circle at bottom,#0f172a 0,#020617 60%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 30;
    }
    .title-inner {
      text-align: center;
      padding: 24px 18px 28px;
      border-radius: 22px;
      background: radial-gradient(circle at top,#0f172a,#020617 65%);
      border: 3px solid #fbbf24;
      box-shadow:
        0 0 0 4px rgba(15,23,42,0.9),
        0 24px 50px rgba(0,0,0,0.9);
      max-width: 360px;
      width: 90%;
    }
    .title-logo-main {
      font-size: 26px;
      margin-bottom: 6px;
      color: #fef9c3;
      font-weight: 900;
      letter-spacing: 0.18em;
      text-shadow:
        0 0 0 #000,
        2px 2px 0 #000,
        -2px 2px 0 #000,
        2px -2px 0 #000,
        -2px -2px 0 #000;
    }
    .title-logo-sub {
      font-size: 14px;
      color: #fbbf24;
      margin-bottom: 16px;
      letter-spacing: 0.14em;
    }
    .title-caption {
      font-size: 12px;
      color: #e5e7eb;
      margin-bottom: 14px;
    }
    .title-btn {
      margin-top: 4px;
    }

    /* オーバーレイ（ターン・セーフ・アウト・勝利） */
    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 25;
      padding: 16px;
    }
    .overlay.show {
      display: flex;
    }
    .overlay-inner {
      width: 100%;
      max-width: 360px;
      padding: 20px 16px 22px;
      border-radius: 20px;
      text-align: center;
      color: #111827;
      box-shadow: 0 24px 50px rgba(0,0,0,0.9);
      animation: popIn 0.25s ease-out;
    }
    .overlay-title {
      font-size: 26px;
      font-weight: 900;
      margin-bottom: 6px;
      letter-spacing: 0.12em;
    }
    .overlay-subtitle {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .overlay-note {
      font-size: 11px;
      opacity: 0.9;
    }

    .overlay-turn {
      background: radial-gradient(circle at top,#bfdbfe,#60a5fa 40%,#1e40af);
      border: 3px solid #facc15;
      color: #0f172a;
    }
    .overlay-safe {
      background: radial-gradient(circle at top,#bbf7d0,#34d399 40%,#166534);
      border: 3px solid #facc15;
      color: #022c22;
    }
    .overlay-out {
      background: radial-gradient(circle at top,#fecaca,#f97316 35%,#7f1d1d);
      border: 3px solid #facc15;
      color: #111827;
    }
    .overlay-win {
      background: radial-gradient(circle at top,#fef9c3,#facc15 35%,#f97316 70%);
      border: 3px solid #ef4444;
      color: #111827;
    }

    @keyframes popIn {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    @media (max-width: 520px) {
      .card { padding: 14px 12px 18px; }
      h1 { font-size: 20px; }
      .chair-circle {
        width: 240px;
        height: 240px;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="card" id="mainCard">

    <!-- タイトル画面 -->
    <div class="title-screen" id="titleScreen">
      <div class="title-inner">
        <div class="title-logo-main">電気イスゲーム</div>
        <div class="title-logo-sub">PARTY BATTLE</div>
        <div class="title-caption">
          12脚のイスから電流イスを読み合う、<br>
          3アウト or 40点先取で勝負が決まる<br>
          心理戦パーティゲーム！
        </div>
        <button id="titleStartBtn" class="btn-primary title-btn">
          ゲームスタート
        </button>
        <div style="font-size:10px;color:#f9fafb;margin-top:8px;">
          ※ 音が鳴らない場合は、画面を一度タップしてからプレイしてください。
        </div>
      </div>
    </div>

    <!-- セットアップ -->
    <div id="setupArea" style="display:none;">
      <h1>プレイヤー設定</h1>
      <div class="subtitle">名前を入力して対戦を始めよう</div>

      <div class="section-title">プレイヤー名</div>
      <div class="row">
        <input id="p1Name" type="text" placeholder="プレイヤー1（例：自分）">
      </div>
      <div class="row">
        <input id="p2Name" type="text" placeholder="プレイヤー2（例：相手）">
      </div>
      <button id="startBtn" class="btn-primary">ゲーム開始</button>
      <div class="small-note">
        ● 電気イスに<strong>3回座ると負け</strong>（3アウト）。<br>
        ● <strong>40点以上先取したら勝ち</strong>。<br>
        ● セーフで獲得したイスは、その後のラウンドでは選べません。
      </div>
    </div>

    <!-- ゲーム本体 -->
    <div id="gameArea" style="display:none;">
      <h1>電気イスゲーム</h1>
      <div class="subtitle">水曜日のダウンタウン風・2人対戦</div>

      <div class="scoreboard">
        <div class="round" id="roundInfo"></div>
        <div class="scores">
          <span id="score1"></span>
          <span id="score2"></span>
        </div>
      </div>

      <div class="current-role" id="roleInfo"></div>

      <div class="section-title">イス（1〜12）</div>
      <div class="chair-area">
        <div class="chair-circle" id="chairsContainer"></div>
      </div>

      <div class="info" id="infoText"></div>
      <div class="result" id="resultText"></div>

      <button id="actionBtn" class="btn-primary"></button>

      <div class="small-note">
        ● 攻撃側は「電気を流すイス」をこっそり1つ選びます。<br>
        ● 防御側は座るイスを選びます。<br>
        ● セーフ：イスの数字が得点になり、そのイスは使用済みに。<br>
        ● アウト：その時点の得点が<strong>0点にリセット</strong>されます。<br>
        ● 3アウトになったプレイヤー or 40点以上のプレイヤーが出た時点で決着。
      </div>
    </div>
  </div>
</div>

<!-- オーバーレイ -->
<div class="overlay" id="overlay">
  <div class="overlay-inner" id="overlayInner">
    <div class="overlay-title" id="overlayTitle"></div>
    <div class="overlay-subtitle" id="overlaySubtitle"></div>
    <div class="overlay-note" id="overlayNote"></div>
  </div>
</div>

<!-- BGM（ファイルは自分で用意） -->
<audio id="bgmTension" src="bgm_tension.mp3" loop></audio>
<audio id="bgmSafe" src="bgm_safe.mp3"></audio>
<audio id="bgmOut" src="bgm_out.mp3"></audio>

<script>
  const titleScreen = document.getElementById('titleScreen');
  const titleStartBtn = document.getElementById('titleStartBtn');

  const p1NameInput = document.getElementById('p1Name');
  const p2NameInput = document.getElementById('p2Name');
  const startBtn = document.getElementById('startBtn');
  const setupArea = document.getElementById('setupArea');
  const gameArea = document.getElementById('gameArea');

  const roundInfo = document.getElementById('roundInfo');
  const score1El = document.getElementById('score1');
  const score2El = document.getElementById('score2');
  const roleInfo = document.getElementById('roleInfo');
  const chairsContainer = document.getElementById('chairsContainer');
  const infoText = document.getElementById('infoText');
  const resultText = document.getElementById('resultText');
  const actionBtn = document.getElementById('actionBtn');

  const overlay = document.getElementById('overlay');
  const overlayInner = document.getElementById('overlayInner');
  const overlayTitle = document.getElementById('overlayTitle');
  const overlaySubtitle = document.getElementById('overlaySubtitle');
  const overlayNote = document.getElementById('overlayNote');

  const bgmTension = document.getElementById('bgmTension');
  const bgmSafe = document.getElementById('bgmSafe');
  const bgmOut = document.getElementById('bgmOut');

  const state = {
    names: ['プレイヤー1','プレイヤー2'],
    scores: [0,0],
    outs: [0,0],
    round: 1,
    maxRounds: 8,
    phase: 'attack', // 'attack' | 'defend' | 'reveal' | 'end'
    attacker: 0,
    defender: 1,
    electricSeat: null,
    defendSeat: null,
    lastHit: false,
    usedSeats: [],
    winnerIndex: null,
    winReason: null // 'outs' | 'score' | null
  };

  function stopAllBgm() {
    [bgmTension, bgmSafe, bgmOut].forEach(a => {
      try {
        a.pause();
        a.currentTime = 0;
      } catch(e) {}
    });
  }

  function playTensionBgm() {
    stopAllBgm();
    bgmTension.play().catch(() => {});
  }
  function playSafeBgm() {
    stopAllBgm();
    bgmSafe.play().catch(() => {});
  }
  function playOutBgm() {
    stopAllBgm();
    bgmOut.play().catch(() => {});
  }

  function showOverlay(type, main, sub, note, duration = 1500) {
    overlayInner.className = 'overlay-inner';
    overlayInner.classList.add(type);
    overlayTitle.textContent = main;
    overlaySubtitle.innerHTML = sub || '';
    overlayNote.innerHTML = note || '';
    overlay.classList.add('show');
    if (duration > 0) {
      setTimeout(() => {
        overlay.classList.remove('show');
      }, duration);
    }
  }

  function showTurnOverlay(playerName) {
    showOverlay(
      'overlay-turn',
      `${playerName} のターン！`,
      '攻撃側が電気を流すイスを選びます',
      'スマホを攻撃側の人だけが見てください。',
      1500
    );
  }

  function showResultOverlay(hit) {
    const defName = state.names[state.defender];
    if (hit) {
      playOutBgm();
      showOverlay(
        'overlay-out',
        'OUT!!',
        `${defName} は電気イスに座ってしまった！`,
        `OUT が ${state.outs[state.defender]} 回になりました。`,
        1700
      );
    } else {
      playSafeBgm();
      showOverlay(
        'overlay-safe',
        'SAFE!!',
        `${defName} は見事に回避！`,
        `イス ${state.defendSeat} の ${state.defendSeat} 点を獲得！`,
        1700
      );
    }
  }

  function showWinOverlay() {
    if (state.winnerIndex == null) return;
    const winnerName = state.names[state.winnerIndex];
    let reasonText = '';
    if (state.winReason === 'outs') {
      const loserIndex = state.winnerIndex === 0 ? 1 : 0;
      const loserName = state.names[loserIndex];
      reasonText = `${loserName} が 3アウトになったため、${winnerName} の勝利！`;
    } else if (state.winReason === 'score') {
      reasonText = `${winnerName} が 40点以上を先取したため、その時点で勝利！`;
    } else {
      reasonText = 'ポイント勝負の結果、より高得点のプレイヤーが勝利！';
    }

    stopAllBgm();
    showOverlay(
      'overlay-win',
      `${winnerName} の勝利！`,
      'ゲームセット！',
      reasonText,
      0 // 自動で閉じない
    );
  }

  function initChairs() {
    chairsContainer.innerHTML = '';
    const count = 12;
    const center = 130;
    const radius = 100; // 少し広げて余裕を持たせる

    for (let i = 1; i <= count; i++) {
      const btn = document.createElement('button');
      btn.className = 'chair';
      btn.dataset.seat = String(i);

      const icon = document.createElement('div');
      icon.className = 'chair-icon';
      const legL = document.createElement('div');
      legL.className = 'chair-leg left';
      const legR = document.createElement('div');
      legR.className = 'chair-leg right';
      icon.appendChild(legL);
      icon.appendChild(legR);

      const label = document.createElement('div');
      label.className = 'chair-label';
      label.textContent = i;

      btn.appendChild(icon);
      btn.appendChild(label);

      const angle = (2 * Math.PI / count) * (i - 1) - Math.PI / 2;
      const x = center + radius * Math.cos(angle);
      const y = center + radius * Math.sin(angle);
      btn.style.left = (x - 28) + 'px';
      btn.style.top = (y - 28) + 'px';

      btn.addEventListener('click', () => onChairClick(i));
      chairsContainer.appendChild(btn);
    }
  }

  function onChairClick(seat) {
    if (state.usedSeats.includes(seat)) return;

    if (state.phase === 'attack') {
      state.electricSeat = seat;
    } else if (state.phase === 'defend') {
      state.defendSeat = seat;
    } else {
      return;
    }
    render();
  }

  function updateScoresDisplay() {
    score1El.innerHTML =
      `<span class="label">${state.names[0]}：</span>` +
      `<strong>${state.scores[0]}</strong> 点 / OUT <strong>${state.outs[0]}</strong> 回`;
    score2El.innerHTML =
      `<span class="label">${state.names[1]}：</span>` +
      `<strong>${state.scores[1]}</strong> 点 / OUT <strong>${state.outs[1]}</strong> 回`;
  }

  function updateRoundAndRoleText() {
    roundInfo.textContent = `ラウンド ${state.round} / ${state.maxRounds}`;
    const atkName = state.names[state.attacker];
    const defName = state.names[state.defender];

    if (state.phase === 'attack') {
      roleInfo.innerHTML =
        `<strong>[攻撃]</strong> ${atkName} が電気を流すイスを選ぶターンです。<br>` +
        `${atkName} だけが画面を見て、選び終わったら「決定して相手に渡す」を押してください。`;
    } else if (state.phase === 'defend') {
      roleInfo.innerHTML =
        `<strong>[防御]</strong> ${defName} が座るイスを選ぶターンです。<br>` +
        `${defName} だけが画面を見て、座りたいイスを選んでください。`;
    } else if (state.phase === 'reveal') {
      roleInfo.innerHTML =
        `結果発表：攻撃は <strong>${atkName}</strong>、防御は <strong>${defName}</strong> でした。`;
    } else if (state.phase === 'end') {
      roleInfo.textContent = 'ゲーム終了';
    }
  }

  function renderChairs() {
    const children = Array.from(chairsContainer.children);
    children.forEach(btn => {
      const n = Number(btn.dataset.seat);
      btn.className = 'chair';
      btn.disabled = false;

      const isUsed = state.usedSeats.includes(n);
      if (state.phase !== 'reveal' && isUsed) {
        btn.classList.add('chair-used');
        btn.disabled = true;
        return;
      }

      if (state.phase === 'attack') {
        if (state.electricSeat === n) {
          btn.classList.add('selected-attack');
        }
      } else if (state.phase === 'defend') {
        if (state.defendSeat === n) {
          btn.classList.add('selected-defend');
        }
      } else if (state.phase === 'reveal') {
        btn.disabled = true;
        const isElectric = state.electricSeat === n;
        const isSeat = state.defendSeat === n;

        if (isElectric && isSeat) {
          btn.classList.add('reveal-hit');
        } else if (isSeat && !isElectric) {
          btn.classList.add('reveal-safe');
        } else if (isElectric) {
          btn.classList.add('selected-attack');
        } else if (isUsed) {
          btn.classList.add('chair-used');
        }
      } else if (state.phase === 'end') {
        btn.disabled = true;
        if (isUsed) btn.classList.add('chair-used');
      }
    });
  }

  function renderInfoAndButton() {
    const atkName = state.names[state.attacker];
    const defName = state.names[state.defender];

    if (state.phase === 'attack') {
      infoText.innerHTML =
        `<strong>${atkName}</strong> は電気を流したいイス（1〜12）を1つ選んでください。<br>` +
        `※ グレーのイスは、すでに得点として取られていて選べません。`;
      resultText.textContent = '';
      actionBtn.textContent = '決定して相手に渡す';
      actionBtn.disabled = state.electricSeat === null;
    } else if (state.phase === 'defend') {
      infoText.innerHTML =
        `<strong>${defName}</strong> は座るイス（1〜12）を1つ選んでください。<br>` +
        `電気が流れていないイスなら、その数字がそのまま得点になります。`;
      resultText.textContent = '';
      actionBtn.textContent = '決定して結果を見る';
      actionBtn.disabled = state.defendSeat === null;
    } else if (state.phase === 'reveal') {
      const hit = state.lastHit;
      const seat = state.defendSeat;

      if (hit) {
        resultText.innerHTML =
          `<span class="highlight">アウト！</span> 電気イスに座ってしまいました。<br>` +
          `<strong>${defName}</strong> の現在の得点は <strong>0点</strong>、OUT は <strong>${state.outs[state.defender]}回</strong> です。`;
      } else {
        resultText.innerHTML =
          `セーフ！ <strong>${defName}</strong> はイス <strong>${seat}</strong> に座り、` +
          `<strong>${seat}点</strong> を手に入れました。`;
      }

      if (state.winnerIndex != null) {
        infoText.innerHTML =
          `勝敗が決まりました。<br>「最終結果を見る」を押して、勝者発表画面へ！`;
        actionBtn.textContent = '最終結果を見る';
        actionBtn.disabled = false;
      } else if (state.round < state.maxRounds) {
        infoText.innerHTML =
          `電気イス：<strong>${state.electricSeat}</strong> ／ 防御側が座ったイス：<strong>${state.defendSeat}</strong><br>` +
          `画面をみんなで確認したら「次のラウンドへ」を押してください。`;
        actionBtn.textContent = '次のラウンドへ';
        actionBtn.disabled = false;
      } else {
        infoText.innerHTML =
          `全 ${state.maxRounds} ラウンド終了。<br>` +
          `画面をみんなで確認したら「最終結果を見る」を押してください。`;
        actionBtn.textContent = '最終結果を見る';
        actionBtn.disabled = false;
      }
    } else if (state.phase === 'end') {
      const [s1, s2] = state.scores;
      let msg;
      if (state.winnerIndex != null) {
        const w = state.winnerIndex;
        msg = `勝者：<strong>${state.names[w]}</strong>！（${s1}点 vs ${s2}点）`;
      } else {
        if (s1 > s2) {
          msg = `勝者：<strong>${state.names[0]}</strong>！（${s1}点 vs ${s2}点）`;
        } else if (s2 > s1) {
          msg = `勝者：<strong>${state.names[1]}</strong>！（${s1}点 vs ${s2}点）`;
        } else {
          msg = `引き分け！ 両者とも <strong>${s1}点</strong> でした。`;
        }
      }
      resultText.innerHTML = msg;
      infoText.textContent = 'おつかれさまでした。もう一度遊ぶ場合は「最初からやり直す」を押してください。';
      actionBtn.textContent = '最初からやり直す';
      actionBtn.disabled = false;
    }
  }

  function render() {
    updateScoresDisplay();
    updateRoundAndRoleText();
    renderChairs();
    renderInfoAndButton();
  }

  function checkWinCondition() {
    // 3アウト敗北 → 相手の勝ち
    for (let i = 0; i < 2; i++) {
      if (state.outs[i] >= 3) {
        state.winnerIndex = i === 0 ? 1 : 0;
        state.winReason = 'outs';
        return;
      }
    }
    // 40点以上先取したプレイヤーが勝ち
    for (let i = 0; i < 2; i++) {
      if (state.scores[i] >= 40) {
        state.winnerIndex = i;
        state.winReason = 'score';
        return;
      }
    }
    state.winnerIndex = null;
    state.winReason = null;
  }

  function startGame() {
    const n1 = p1NameInput.value.trim();
    const n2 = p2NameInput.value.trim();
    state.names[0] = n1 || 'プレイヤー1';
    state.names[1] = n2 || 'プレイヤー2';

    state.scores = [0,0];
    state.outs = [0,0];
    state.round = 1;
    state.phase = 'attack';
    state.attacker = 0;
    state.defender = 1;
    state.electricSeat = null;
    state.defendSeat = null;
    state.lastHit = false;
    state.usedSeats = [];
    state.winnerIndex = null;
    state.winReason = null;

    setupArea.style.display = 'none';
    gameArea.style.display = 'block';
    initChairs();
    render();
    playTensionBgm();
    showTurnOverlay(state.names[state.attacker]);
  }

  function nextPhase() {
    if (state.phase === 'attack') {
      state.phase = 'defend';
      state.defendSeat = null;
      render();
    } else if (state.phase === 'defend') {
      const hit = state.electricSeat === state.defendSeat;
      state.lastHit = hit;
      const def = state.defender;

      if (hit) {
        state.outs[def] += 1;
        state.scores[def] = 0;
      } else {
        state.scores[def] += state.defendSeat;
        if (!state.usedSeats.includes(state.defendSeat)) {
          state.usedSeats.push(state.defendSeat);
          state.usedSeats.sort((a,b) => a - b);
        }
      }

      checkWinCondition();
      state.phase = 'reveal';
      stopAllBgm();
      showResultOverlay(hit);
      render();
    } else if (state.phase === 'reveal') {
      if (state.winnerIndex != null || state.round >= state.maxRounds) {
        state.phase = 'end';
        render();
        showWinOverlay();
      } else {
        // 次ラウンドへ
        state.round += 1;
        state.attacker = (state.attacker === 0) ? 1 : 0;
        state.defender = 1 - state.attacker;
        state.electricSeat = null;
        state.defendSeat = null;
        state.lastHit = false;
        state.phase = 'attack';
        playTensionBgm();
        showTurnOverlay(state.names[state.attacker]);
        render();
      }
    } else if (state.phase === 'end') {
      // 最初に戻る
      overlay.classList.remove('show');
      gameArea.style.display = 'none';
      setupArea.style.display = 'block';
      resultText.textContent = '';
      infoText.textContent = '';
      stopAllBgm();
    }
  }

  titleStartBtn.addEventListener('click', () => {
    titleScreen.style.display = 'none';
    setupArea.style.display = 'block';
  });

  startBtn.addEventListener('click', startGame);
  actionBtn.addEventListener('click', nextPhase);

  [p1NameInput, p2NameInput].forEach(i => {
    i.addEventListener('keydown', e => {
      if (e.key === 'Enter') startGame();
    });
  });

  // 初期イスレイアウト
  initChairs();
</script>
</body>
</html>

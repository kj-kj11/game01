<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>かじこじゲーム 電気イス</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- フォント -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rampart+One&family=Yusei+Magic&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Yusei Magic", -apple-system, BlinkMacSystemFont, "Yu Gothic", "ヒラギノ角ゴ ProN W3", system-ui, sans-serif;
      background-color: #ffe36a;
      background-image:
        radial-gradient(#f5d76e 1px, transparent 1px),
        radial-gradient(#f5d76e 1px, transparent 1px);
      background-position: 0 0, 2px 2px;
      background-size: 4px 4px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #2d3436;
    }

    .app {
      width: 100%;
      max-width: 560px;
      padding: 16px;
      position: relative;
      z-index: 1;
    }

    .card {
      background: #fffdf7;
      border-radius: 22px;
      border: 4px solid #f9ca24;
      padding: 16px 16px 20px;
      box-shadow:
        0 12px 26px rgba(0,0,0,0.3),
        0 0 0 5px rgba(255,255,255,0.9);
    }

    .logo-font {
      font-family: "Rampart One", "Yusei Magic", system-ui, sans-serif;
      font-weight: 900;
      letter-spacing: 0.18em;
    }

    .subtitle {
      font-size: 11px;
      color: #636e72;
      text-align: center;
      margin-bottom: 14px;
    }

    .row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    input[type="text"],
    input[type="number"] {
      flex: 1;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #b2bec3;
      background: #ffffff;
      color: #2d3436;
      font-size: 14px;
    }
    input[type="text"]:focus,
    input[type="number"]:focus {
      outline: none;
      border-color: #0984e3;
      box-shadow: 0 0 0 2px rgba(9,132,227,0.25);
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 9px 16px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.08s ease, box-shadow 0.08s ease, opacity 0.1s, filter 0.1s;
      font-weight: 700;
      font-family: "Yusei Magic", system-ui, sans-serif;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: none;
      filter: brightness(0.95);
    }
    button:disabled {
      opacity: .45;
      cursor: default;
      box-shadow: none;
    }
    .btn-primary {
      background: linear-gradient(135deg,#ff4b5c,#ff9f1a);
      color: #ffffff;
      text-shadow: 0 0 4px rgba(0,0,0,0.3);
      box-shadow: 0 6px 14px rgba(0,0,0,0.35);
      width: 100%;
      border: 2px solid #000000;
    }

    .section-title {
      font-size: 12px;
      color: #636e72;
      margin-bottom: 4px;
      font-weight: 700;
    }
    .section-sub {
      font-size: 11px;
      color: #b2bec3;
      margin-bottom: 4px;
    }

    .scoreboard {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px 10px;
      border-radius: 14px;
      background: linear-gradient(90deg,#ff4b5c,#ff9f1a,#ffde59);
      border: 3px solid #000;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      color: #ffffff;
      text-shadow: 0 0 4px rgba(0,0,0,0.5);
    }
    .round {
      font-size: 13px;
      font-weight: 900;
    }
    .scores {
      display: flex;
      gap: 10px;
      font-size: 11px;
    }
    .scores span strong {
      font-size: 15px;
    }

    .label { font-size: 11px; }

    .current-role {
      margin-bottom: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 2px solid #000;
      font-size: 12px;
      background: #ffeaa7;
      color: #2d3436;
      box-shadow: 0 4px 0 #f1c40f;
    }
    .current-role strong { color: #e74c3c; }

    /* イス配置 */
    .chair-area {
      display: flex;
      justify-content: center;
      margin: 10px 0 14px;
    }
    .chair-circle {
      position: relative;
      width: 340px;
      height: 340px;
      max-width: 100%;
      max-height: 100%;
      border-radius: 50%;
      background:
        radial-gradient(circle at center,#ffffff 0,#ffeaa7 40%,#ffde59 75%);
      box-shadow: inset 0 0 20px rgba(0,0,0,0.15);
      border: 3px solid #000;
    }

    .chair {
      position: absolute;
      width: 70px;    /* JS で上書きされます */
      height: 70px;
      border-radius: 22px;
      border: 3px solid #000;
      background: #ffffff;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: background 0.12s, transform 0.08s, border-color 0.12s, box-shadow 0.12s, opacity 0.12s;
      box-shadow: 0 3px 0 #636e72;
    }

    .chair-icon {
      width: 40px;
      height: 48px;
      background-image: url("chair_icon.png");
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      margin-bottom: 0;
    }
    .chair-label {
      font-size: 18px;
      font-weight: 900;
      color: #ff4b5c;
      text-shadow: 0 0 2px rgba(255,255,255,0.8);
    }

    .chair.selected-attack {
      background: #ffde59;
      border-color: #000;
      box-shadow: 0 0 0 3px #ff4b5c;
      transform: scale(1.06);
    }
    .chair.selected-defend {
      background: #74b9ff;
      border-color: #000;
      box-shadow: 0 0 0 3px #0984e3;
      transform: scale(1.06);
    }
    .chair.reveal-hit {
      background: #ff7675;
      border-color: #000;
      animation: pulseHit .7s ease-in-out 3;
    }
    .chair.reveal-safe {
      background: #55efc4;
      border-color: #000;
      animation: pulseSafe .7s ease-in-out 3;
    }
    .chair-used {
      background: #dfe6e9;
      border-style: solid;
      border-color: #636e72;
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
    }

    @keyframes pulseHit {
      0% { transform: scale(1); }
      50% { transform: scale(1.08); }
      100% { transform: scale(1); }
    }
    @keyframes pulseSafe {
      0% { transform: scale(1); }
      50% { transform: scale(1.08); }
      100% { transform: scale(1); }
    }

    .info {
      font-size: 12px;
      color: #2d3436;
      min-height: 32px;
      margin-bottom: 6px;
    }
    .info strong { color: #e74c3c; }
    .highlight { color: #d63031; font-weight: 700; }

    .result {
      font-size: 13px;
      margin-bottom: 8px;
      min-height: 34px;
      color: #2d3436;
    }

    .small-note {
      font-size: 11px;
      color: #636e72;
      margin-top: 6px;
      line-height: 1.4;
    }

    /* タイトル画面など（前回と同じ） */
    .title-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 30;
      background-color: #ffe36a;
      background-image:
        radial-gradient(#f5d76e 1px, transparent 1px),
        radial-gradient(#f5d76e 1px, transparent 1px);
      background-position: 0 0, 2px 2px;
      background-size: 4px 4px;
    }
    .title-inner {
      text-align: center;
      padding: 26px 18px 28px;
      border-radius: 26px;
      background: #fffdf7;
      border: 4px solid #000;
      box-shadow:
        0 18px 32px rgba(0,0,0,0.4),
        0 0 0 6px #ffde59;
      max-width: 380px;
      width: 90%;
    }
    .title-logo-wrap {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }
    .title-logo-img {
      max-width: 260px;
      width: 100%;
      height: auto;
      display: block;
      image-rendering: crisp-edges;
    }
    .title-subplate {
      display: inline-block;
      margin-bottom: 14px;
      padding: 4px 16px;
      border-radius: 999px;
      background: #ff4b5c;
      border: 3px solid #000;
      box-shadow: 0 4px 0 #c0392b;
    }
    .title-subplate span {
      color: #ffffff;
      font-size: 16px;
      font-weight: 900;
      text-shadow: 0 0 4px rgba(0,0,0,0.4);
      letter-spacing: 0.15em;
      font-family: "Rampart One","Yusei Magic",system-ui,sans-serif;
    }
    .title-caption {
      font-size: 12px;
      color: #636e72;
      margin-bottom: 14px;
    }
    .title-btn { margin-top: 4px; }

    .section-logo-img {
      max-width: 220px;
      width: 100%;
      height: auto;
      display: block;
      margin: 0 auto 8px;
      image-rendering: crisp-edges;
    }

    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 25;
      padding: 16px;
    }
    .overlay.show { display: flex; }
    .overlay-inner {
      width: 100%;
      max-width: 360px;
      padding: 18px 16px 18px;
      border-radius: 22px;
      text-align: center;
      color: #2d3436;
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
      animation: popIn 0.25s ease-out;
      border: 4px solid #000;
      background: #fffdf7;
    }
    .overlay-title {
      font-size: 22px;
      margin-bottom: 6px;
      font-weight: 900;
      letter-spacing: 0.18em;
      text-shadow:
        0 0 0 #fff,
        2px 2px 0 #ffeaa7,
        -2px 2px 0 #ffeaa7;
    }
    .overlay-subtitle { font-size: 14px; font-weight: 600; margin-bottom: 8px; }
    .overlay-note { font-size: 11px; opacity: 0.9; }
    .overlay-btn { margin-top: 12px; width: 100%; }

    .overlay-turn {
      background:
        radial-gradient(circle at center,#ffe36a 0,#ffde59 45%,#ff9f1a 100%);
    }
    .overlay-turn .overlay-inner { background:#fffdf7; }

    .overlay-safe {
      background:
        radial-gradient(circle at center,#c7f9cc 0,#55efc4 45%,#00b894 100%);
    }
    .overlay-safe .overlay-inner { background:#ffffff; border-color:#000; }
    .overlay-safe .overlay-title { color:#00b894; }

    .overlay-out {
      background:
        radial-gradient(circle at center,#ffb3b3 0,#ff7675 45%,#d63031 100%);
    }
    .overlay-out .overlay-inner { background:#ffffff; border-color:#000; }
    .overlay-out .overlay-title { color:#d63031; }

    .overlay-win {
      background:
        radial-gradient(circle at center,#ffde59 0,#ff9f1a 45%,#ff4b5c 100%);
    }
    .overlay-win .overlay-inner { background:#ffffff; border-color:#000; }
    .overlay-win .overlay-title { color:#ff4b5c; }

    @keyframes popIn {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    @media (max-width: 560px) {
      .card { padding: 14px 12px 18px; }
      .chair-circle {
        width: 320px;
        height: 320px;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="card" id="mainCard">

    <!-- タイトル画面 -->
    <div class="title-screen" id="titleScreen">
      <div class="title-inner">
        <div class="title-logo-wrap">
          <img src="kajikoji_logo_main.png" alt="かじこじゲーム ロゴ" class="title-logo-img">
        </div>
        <div class="title-subplate">
          <span>電気イスゲーム</span>
        </div>
        <div class="title-caption">
          12脚のイスから電流イスを読み合う、<br>
          アウト回数と勝利点を決めて遊べる<br>
          2人用心理戦パーティゲーム！
        </div>
        <button id="titleStartBtn" class="btn-primary title-btn">
          ゲームスタート！
        </button>
        <div style="font-size:10px;color:#636e72;margin-top:8px;">
          ※ 音が鳴らない場合は、画面を一度タップしてからプレイしてください。
        </div>
      </div>
    </div>

    <!-- セットアップ -->
    <div id="setupArea" style="display:none;">
      <img src="kajikoji_logo_main.png" alt="かじこじゲーム ロゴ" class="section-logo-img">
      <div class="subtitle">名前とゲームルールを決めて対戦スタート！</div>

      <div class="section-title">プレイヤー名</div>
      <div class="row">
        <input id="p1Name" type="text" placeholder="プレイヤー1（例：自分）">
      </div>
      <div class="row">
        <input id="p2Name" type="text" placeholder="プレイヤー2（例：相手）">
      </div>

      <div style="height:8px;"></div>

      <div class="section-title">ゲーム設定</div>
      <div class="section-sub">※未入力の場合はデフォルト値が使われます</div>
      <div class="row">
        <input id="roundCount" type="number" min="1" max="20" value="10" placeholder="ラウンド数">
        <input id="maxOuts" type="number" min="1" max="10" value="3" placeholder="アウトで負け">
      </div>
      <div class="row">
        <input id="winScore" type="number" min="1" max="200" value="40" placeholder="勝利点">
      </div>

      <button id="startBtn" class="btn-primary">ゲーム開始</button>
      <div class="small-note">
        ● ラウンド数 … 最大何ラウンドまで戦うか。<br>
        ● アウト … この回数アウトになるとその場で負け。<br>
        ● 勝利点 … この点数以上になった時点で勝ち。<br>
        ● ルールは毎回ここで変更できます。
      </div>
    </div>

    <!-- ゲーム本体 -->
    <div id="gameArea" style="display:none;">
      <img src="kajikoji_logo_main.png" alt="かじこじゲーム ロゴ" class="section-logo-img">
      <div class="subtitle">2人対戦・1台のスマホで遊べる心理戦ゲーム</div>

      <div class="scoreboard">
        <div class="round" id="roundInfo"></div>
        <div class="scores">
          <span id="score1"></span>
          <span id="score2"></span>
        </div>
      </div>

      <div class="current-role" id="roleInfo"></div>

      <div class="section-title">イス（1〜12）</div>
      <div class="chair-area">
        <div class="chair-circle" id="chairsContainer"></div>
      </div>

      <div class="info" id="infoText"></div>
      <div class="result" id="resultText"></div>

      <button id="actionBtn" class="btn-primary"></button>

      <div class="small-note">
        ● 攻撃側は「電気を流すイス」をこっそり1つ選びます。<br>
        ● 防御側は座るイスを選びます。<br>
        ● セーフ：イスの数字が得点になり、そのイスは使用済みに。<br>
        ● アウト：その時点の得点が<strong>0点にリセット</strong>されます。<br>
        ● アウト回数と勝利点・ラウンド数は、スタート画面で設定した値が使われます。
      </div>
    </div>
  </div>
</div>

<!-- オーバーレイ -->
<div class="overlay" id="overlay">
  <div class="overlay-inner" id="overlayInner">
    <div class="overlay-title logo-font" id="overlayTitle"></div>
    <div class="overlay-subtitle" id="overlaySubtitle"></div>
    <div class="overlay-note" id="overlayNote"></div>
    <button id="overlayRestartBtn" class="btn-primary overlay-btn" style="display:none;">
      最初からやり直す
    </button>
  </div>
</div>

<!-- BGM -->
<audio id="bgmTension" src="bgm_tension.mp3" loop></audio>
<audio id="bgmSafe" src="bgm_safe.mp3"></audio>
<audio id="bgmOut" src="bgm_out.mp3"></audio>

<script>
  const titleScreen = document.getElementById('titleScreen');
  const titleStartBtn = document.getElementById('titleStartBtn');

  const p1NameInput = document.getElementById('p1Name');
  const p2NameInput = document.getElementById('p2Name');
  const roundCountInput = document.getElementById('roundCount');
  const maxOutsInput = document.getElementById('maxOuts');
  const winScoreInput = document.getElementById('winScore');

  const startBtn = document.getElementById('startBtn');
  const setupArea = document.getElementById('setupArea');
  const gameArea = document.getElementById('gameArea');

  const roundInfo = document.getElementById('roundInfo');
  const score1El = document.getElementById('score1');
  const score2El = document.getElementById('score2');
  const roleInfo = document.getElementById('roleInfo');
  const chairsContainer = document.getElementById('chairsContainer');
  const infoText = document.getElementById('infoText');
  const resultText = document.getElementById('resultText');
  const actionBtn = document.getElementById('actionBtn');

  const overlay = document.getElementById('overlay');
  const overlayTitle = document.getElementById('overlayTitle');
  const overlaySubtitle = document.getElementById('overlaySubtitle');
  const overlayNote = document.getElementById('overlayNote');
  const overlayRestartBtn = document.getElementById('overlayRestartBtn');

  const bgmTension = document.getElementById('bgmTension');
  const bgmSafe = document.getElementById('bgmSafe');
  const bgmOut = document.getElementById('bgmOut');

  const state = {
    names: ['プレイヤー1','プレイヤー2'],
    scores: [0,0],
    outs: [0,0],
    round: 1,
    maxRounds: 10,
    maxOuts: 3,
    winScore: 40,
    phase: 'attack',
    attacker: 0,
    defender: 1,
    electricSeat: null,
    defendSeat: null,
    lastHit: false,
    usedSeats: [],
    winnerIndex: null,
    winReason: null
  };

  function stopAllBgm() {
    [bgmTension, bgmSafe, bgmOut].forEach(a => {
      try { a.pause(); a.currentTime = 0; } catch(e) {}
    });
  }
  function playTensionBgm() { stopAllBgm(); bgmTension.play().catch(()=>{}); }
  function playSafeBgm()     { stopAllBgm(); bgmSafe.play().catch(()=>{}); }
  function playOutBgm()      { stopAllBgm(); bgmOut.play().catch(()=>{}); }

  function showOverlayBox(type, main, sub, note, duration = 1500) {
    overlay.className = 'overlay ' + type;
    overlayTitle.textContent = main;
    overlaySubtitle.innerHTML = sub || '';
    overlayNote.innerHTML = note || '';
    overlayRestartBtn.style.display = 'none';
    overlay.classList.add('show');
    if (duration > 0) {
      setTimeout(()=>{ overlay.classList.remove('show'); }, duration);
    }
  }

  function showTurnOverlay(playerName, role) {
    const sub =
      role === 'attack'
        ? '攻撃ターン：電気を流すイスを1つ選びます'
        : '防御ターン：座るイスを1つ選びます';
    const note =
      role === 'attack'
        ? 'スマホを攻撃側の人だけが見てください。'
        : 'スマホを防御側の人だけが見てください。';
    showOverlayBox('overlay-turn', `${playerName} のターン！`, sub, note, 1500);
  }

  function showResultOverlay(hit) {
    const defName = state.names[state.defender];
    if (hit) {
      playOutBgm();
      showOverlayBox(
        'overlay-out',
        'アウト!!',
        `${defName} は電気イスに座ってしまった！`,
        `OUT が ${state.outs[state.defender]} 回になりました（${state.maxOuts} アウトで敗北）。`,
        1700
      );
    } else {
      playSafeBgm();
      showOverlayBox(
        'overlay-safe',
        'セーフ!!',
        `${defName} は見事に回避！`,
        `イス ${state.defendSeat} の ${state.defendSeat} 点を獲得！`,
        1700
      );
    }
  }

  function showWinOverlay() {
    if (state.winnerIndex == null) return;
    const winnerName = state.names[state.winnerIndex];
    let reasonText = '';
    if (state.winReason === 'outs') {
      const loserIndex = state.winnerIndex === 0 ? 1 : 0;
      const loserName = state.names[loserIndex];
      reasonText = `${loserName} が ${state.maxOuts} アウトになったため、${winnerName} の勝利！`;
    } else if (state.winReason === 'score') {
      reasonText = `${winnerName} が ${state.winScore}点以上を先取したため、その時点で勝利！`;
    } else {
      reasonText = 'ポイント勝負の結果、より高得点のプレイヤーが勝利！';
    }
    stopAllBgm();
    overlay.className = 'overlay overlay-win';
    overlayTitle.textContent = `${winnerName} の勝利！`;
    overlaySubtitle.innerHTML = 'ゲームセット！';
    overlayNote.innerHTML = reasonText;
    overlayRestartBtn.style.display = 'block';
    overlay.classList.add('show');
  }

  // ★イスの配置ロジック：画面いっぱいまで大きくしつつ、重なりを最小限に抑える
  function initChairs() {
    chairsContainer.innerHTML = '';
    const count = 12;

    const rect = chairsContainer.getBoundingClientRect();
    let size = rect.width || 340;
    if (rect.height) size = Math.min(size, rect.height);

    const margin = 8;
    const sin15 = Math.sin(Math.PI / 12);

    // 理論上「ちょうど重ならない」ボタン幅
    const wMax = sin15 * (size - 2 * margin) / (1 + sin15);

    // 見やすさ優先で 1.02 倍 → ほんの少しだけ重なるが、そのぶん大きく表示
    let buttonSize = wMax * 1.02;

    // 安全な範囲にクランプ
    if (buttonSize < 56) buttonSize = 56;
    if (buttonSize > 72) buttonSize = 72;

    const buttonHalf = buttonSize / 2;
    const radius = size / 2 - buttonHalf - margin;

    for (let seat = 1; seat <= count; seat++) {
      const btn = document.createElement('button');
      btn.className = 'chair';
      btn.dataset.seat = String(seat);

      btn.style.width  = buttonSize + 'px';
      btn.style.height = buttonSize + 'px';

      const icon = document.createElement('div');
      icon.className = 'chair-icon';

      const label = document.createElement('div');
      label.className = 'chair-label';
      label.textContent = seat;

      btn.appendChild(icon);
      btn.appendChild(label);

      // 12 が一番上 → 1,2,... と時計回り
      const posIndex = seat % count; // 12→0, 1→1, 2→2…
      const angle = (2 * Math.PI / count) * posIndex - Math.PI / 2;

      const x = size / 2 + radius * Math.cos(angle);
      const y = size / 2 + radius * Math.sin(angle);

      btn.style.left = (x - buttonHalf) + 'px';
      btn.style.top  = (y - buttonHalf) + 'px';

      btn.addEventListener('click', () => onChairClick(seat));
      chairsContainer.appendChild(btn);
    }
  }

  function onChairClick(seat) {
    if (state.usedSeats.includes(seat)) return;
    if (state.phase === 'attack') {
      state.electricSeat = seat;
    } else if (state.phase === 'defend') {
      state.defendSeat = seat;
    } else {
      return;
    }
    render();
  }

  function updateScoresDisplay() {
    score1El.innerHTML =
      `<span class="label">${state.names[0]}：</span>` +
      `<strong>${state.scores[0]}</strong> 点 / OUT <strong>${state.outs[0]}</strong> 回`;
    score2El.innerHTML =
      `<span class="label">${state.names[1]}：</span>` +
      `<strong>${state.scores[1]}</strong> 点 / OUT <strong>${state.outs[1]}</strong> 回`;
  }

  function updateRoundAndRoleText() {
    roundInfo.textContent = `ラウンド ${state.round} / ${state.maxRounds}`;
    const atkName = state.names[state.attacker];
    const defName = state.names[state.defender];

    if (state.phase === 'attack') {
      roleInfo.innerHTML =
        `<strong>[攻撃]</strong> ${atkName} が電気を流すイスを選ぶターンです。<br>` +
        `${atkName} だけが画面を見て、選び終わったら「決定して相手に渡す」を押してください。`;
    } else if (state.phase === 'defend') {
      roleInfo.innerHTML =
        `<strong>[防御]</strong> ${defName} が座るイスを選ぶターンです。<br>` +
        `${defName} だけが画面を見て、座りたいイスを選んでください。`;
    } else if (state.phase === 'reveal') {
      roleInfo.innerHTML =
        `結果発表：攻撃は <strong>${atkName}</strong>、防御は <strong>${defName}</strong> でした。`;
    } else if (state.phase === 'end') {
      roleInfo.textContent = 'ゲーム終了';
    }
  }

  function renderChairs() {
    const children = Array.from(chairsContainer.children);
    children.forEach(btn => {
      const n = Number(btn.dataset.seat);
      btn.className = 'chair';
      btn.disabled = false;

      const isUsed = state.usedSeats.includes(n);
      if (state.phase !== 'reveal' && isUsed) {
        btn.classList.add('chair-used');
        btn.disabled = true;
        return;
      }

      if (state.phase === 'attack') {
        if (state.electricSeat === n) btn.classList.add('selected-attack');
      } else if (state.phase === 'defend') {
        if (state.defendSeat === n) btn.classList.add('selected-defend');
      } else if (state.phase === 'reveal') {
        btn.disabled = true;
        const isElectric = state.electricSeat === n;
        const isSeat = state.defendSeat === n;

        if (isElectric && isSeat) {
          btn.classList.add('reveal-hit');
        } else if (isSeat && !isElectric) {
          btn.classList.add('reveal-safe');
        } else if (isElectric) {
          btn.classList.add('selected-attack');
        } else if (isUsed) {
          btn.classList.add('chair-used');
        }
      } else if (state.phase === 'end') {
        btn.disabled = true;
        if (isUsed) btn.classList.add('chair-used');
      }
    });
  }

  function renderInfoAndButton() {
    const atkName = state.names[state.attacker];
    const defName = state.names[state.defender];

    if (state.phase === 'attack') {
      infoText.innerHTML =
        `<strong>${atkName}</strong> は電気を流したいイス（1〜12）を1つ選んでください。<br>` +
        `※ グレーのイスは、すでに得点として取られていて選べません。`;
      resultText.textContent = '';
      actionBtn.textContent = '決定して相手に渡す';
      actionBtn.disabled = state.electricSeat === null;
    } else if (state.phase === 'defend') {
      infoText.innerHTML =
        `<strong>${defName}</strong> は座るイス（1〜12）を1つ選んでください。<br>` +
        `電気が流れていないイスなら、その数字がそのまま得点になります。`;
      resultText.textContent = '';
      actionBtn.textContent = '決定して結果を見る';
      actionBtn.disabled = state.defendSeat === null;
    } else if (state.phase === 'reveal') {
      const hit = state.lastHit;
      const seat = state.defendSeat;

      if (hit) {
        resultText.innerHTML =
          `<span class="highlight">アウト！</span> 電気イスに座ってしまいました。<br>` +
          `<strong>${defName}</strong> の現在の得点は <strong>0点</strong>、OUT は <strong>${state.outs[state.defender]}回</strong> です。`;
      } else {
        resultText.innerHTML =
          `セーフ！ <strong>${defName}</strong> はイス <strong>${seat}</strong> に座り、` +
          `<strong>${seat}点</strong> を手に入れました。`;
      }

      if (state.winnerIndex != null) {
        infoText.innerHTML =
          `勝敗が決まりました。<br>「最終結果を見る」を押して、勝者発表画面へ！`;
        actionBtn.textContent = '最終結果を見る';
        actionBtn.disabled = false;
      } else if (state.round < state.maxRounds) {
        infoText.innerHTML =
          `電気イス：<strong>${state.electricSeat}</strong> ／ 防御側が座ったイス：<strong>${state.defendSeat}</strong><br>` +
          `画面をみんなで確認したら「次のラウンドへ」を押してください。`;
        actionBtn.textContent = '次のラウンドへ';
        actionBtn.disabled = false;
      } else {
        infoText.innerHTML =
          `全 ${state.maxRounds} ラウンド終了。<br>` +
          `画面をみんなで確認したら「最終結果を見る」を押してください。`;
        actionBtn.textContent = '最終結果を見る';
        actionBtn.disabled = false;
      }
    } else if (state.phase === 'end') {
      const [s1, s2] = state.scores;
      let msg;
      if (state.winnerIndex != null) {
        const w = state.winnerIndex;
        msg = `勝者：<strong>${state.names[w]}</strong>！（${s1}点 vs ${s2}点）`;
      } else if (s1 > s2) {
        msg = `勝者：<strong>${state.names[0]}</strong>！（${s1}点 vs ${s2}点）`;
      } else if (s2 > s1) {
        msg = `勝者：<strong>${state.names[1]}</strong>！（${s1}点 vs ${s2}点）`;
      } else {
        msg = `引き分け！ 両者とも <strong>${s1}点</strong> でした。`;
      }
      resultText.innerHTML = msg;
      infoText.textContent = 'おつかれさまでした。もう一度遊ぶ場合は「最初からやり直す」を押してください。';
      actionBtn.textContent = '最初からやり直す';
      actionBtn.disabled = false;
    }
  }

  function render() {
    updateScoresDisplay();
    updateRoundAndRoleText();
    renderChairs();
    renderInfoAndButton();
  }

  function checkWinCondition() {
    for (let i = 0; i < 2; i++) {
      if (state.outs[i] >= state.maxOuts) {
        state.winnerIndex = i === 0 ? 1 : 0;
        state.winReason = 'outs';
        return;
      }
    }
    for (let i = 0; i < 2; i++) {
      if (state.scores[i] >= state.winScore) {
        state.winnerIndex = i;
        state.winReason = 'score';
        return;
      }
    }
    state.winnerIndex = null;
    state.winReason = null;
  }

  function resetToSetup() {
    overlay.classList.remove('show');
    gameArea.style.display = 'none';
    setupArea.style.display = 'block';
    resultText.textContent = '';
    infoText.textContent = '';
    stopAllBgm();
  }

  function startGame() {
    const n1 = p1NameInput.value.trim();
    const n2 = p2NameInput.value.trim();
    state.names[0] = n1 || 'プレイヤー1';
    state.names[1] = n2 || 'プレイヤー2';

    let rounds = parseInt(roundCountInput.value, 10);
    let outs = parseInt(maxOutsInput.value, 10);
    let winScore = parseInt(winScoreInput.value, 10);
    if (isNaN(rounds)) rounds = 10;
    if (isNaN(outs)) outs = 3;
    if (isNaN(winScore)) winScore = 40;
    rounds = Math.min(Math.max(rounds, 1), 20);
    outs = Math.min(Math.max(outs, 1), 10);
    winScore = Math.min(Math.max(winScore, 1), 200);

    state.maxRounds = rounds;
    state.maxOuts = outs;
    state.winScore = winScore;

    state.scores = [0,0];
    state.outs = [0,0];
    state.round = 1;
    state.phase = 'attack';
    state.attacker = 0;
    state.defender = 1;
    state.electricSeat = null;
    state.defendSeat = null;
    state.lastHit = false;
    state.usedSeats = [];
    state.winnerIndex = null;
    state.winReason = null;

    setupArea.style.display = 'none';
    gameArea.style.display = 'block';
    initChairs();
    render();
    playTensionBgm();
    showTurnOverlay(state.names[state.attacker],'attack');
  }

  function nextPhase() {
    if (state.phase === 'attack') {
      state.phase = 'defend';
      state.defendSeat = null;
      render();
      showTurnOverlay(state.names[state.defender],'defend');
    } else if (state.phase === 'defend') {
      const hit = state.electricSeat === state.defendSeat;
      state.lastHit = hit;
      const def = state.defender;

      if (hit) {
        state.outs[def] += 1;
        state.scores[def] = 0;
      } else {
        state.scores[def] += state.defendSeat;
        if (!state.usedSeats.includes(state.defendSeat)) {
          state.usedSeats.push(state.defendSeat);
          state.usedSeats.sort((a,b)=>a-b);
        }
      }
      checkWinCondition();
      state.phase = 'reveal';
      stopAllBgm();
      showResultOverlay(hit);
      render();
    } else if (state.phase === 'reveal') {
      if (state.winnerIndex != null || state.round >= state.maxRounds) {
        state.phase = 'end';
        render();
        showWinOverlay();
      } else {
        state.round += 1;
        state.attacker = state.attacker === 0 ? 1 : 0;
        state.defender = 1 - state.attacker;
        state.electricSeat = null;
        state.defendSeat = null;
        state.lastHit = false;
        state.phase = 'attack';
        playTensionBgm();
        showTurnOverlay(state.names[state.attacker],'attack');
        render();
      }
    } else if (state.phase === 'end') {
      resetToSetup();
    }
  }

  titleStartBtn.addEventListener('click', () => {
    titleScreen.style.display = 'none';
    setupArea.style.display = 'block';
  });

  startBtn.addEventListener('click', startGame);
  actionBtn.addEventListener('click', nextPhase);
  overlayRestartBtn.addEventListener('click', resetToSetup);

  [p1NameInput, p2NameInput, roundCountInput, maxOutsInput, winScoreInput].forEach(i => {
    i.addEventListener('keydown', e => {
      if (e.key === 'Enter') startGame();
    });
  });

  // 初期化（レイアウト計算用）
  initChairs();
</script>
</body>
</html>
